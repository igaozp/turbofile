# imFile UI 组件架构详解

## 概述

imFile 的 UI 组件架构基于 Vue.js 2.7 + Element UI，采用组件化开发模式。界面设计现代简洁，支持深色/浅色主题切换，具有良好的响应式布局和用户交互体验。

## 整体布局结构

### 主容器布局 (Main.vue)

```vue
<template>
  <el-container id="container">
    <mo-aside />                    <!-- 侧边栏导航 -->
    <router-view />                 <!-- 主要内容区 -->
    <mo-speedometer />              <!-- 速度计组件 -->
    <mo-add-task />                 <!-- 添加任务对话框 -->
    <mo-about-panel />              <!-- 关于面板 -->
    <mo-task-detail />              <!-- 任务详情抽屉 -->
    <mo-dragger />                  <!-- 拖拽组件 -->
  </el-container>
</template>
```

### 布局特点

1. **固定侧边栏**：78px 宽度，包含主要导航功能
2. **主内容区**：自适应宽度，显示任务列表或设置页面
3. **浮动组件**：速度计、对话框等覆盖在主内容之上
4. **响应式设计**：在小屏幕设备上隐藏侧边栏

## 核心 UI 组件

### 1. 侧边栏组件 (Aside/Index.vue)

```vue
<template>
  <el-aside width="78px" :class="['aside', 'hidden-sm-and-down']">
    <div class="aside-inner">
      <mo-logo-mini />              <!-- Logo -->
      
      <!-- 顶部菜单 -->
      <ul class="menu top-menu">
        <li @click="nav('/task')">
          <mo-icon name="menu-task" width="30" height="30" />
        </li>
        <li @click="showAddTask()">
          <mo-icon name="menu-add" width="30" height="30" />
        </li>
      </ul>
      
      <!-- 底部菜单 -->
      <ul class="menu bottom-menu">
        <li @click="nav('/preference')">
          <mo-icon name="menu-preference" width="30" height="30" />
        </li>
        <li @click="showAboutPanel">
          <mo-icon name="menu-about" width="30" height="30" />
        </li>
      </ul>
    </div>
  </el-aside>
</template>
```

#### 功能特性：
- **简洁导航**：4 个主要功能入口
- **图标设计**：SVG 图标，支持主题色彩
- **响应式**：小屏幕时自动隐藏
- **macOS 特性**：支持透明背景效果

### 2. 任务列表组件

#### TaskList.vue - 任务列表容器
```vue
<template>
  <div class="task-list">
    <!-- 任务子导航 -->
    <mo-task-subnav 
      :current="currentList"
      :count="count"
      @change="handleCurrentListChange"
    />
    
    <!-- 任务列表 -->
    <div class="task-list-wrapper">
      <mo-drag-select>
        <mo-task-item
          v-for="task in taskList"
          :key="task.gid"
          :task="task"
          @click="handleTaskClick"
        />
      </mo-drag-select>
    </div>
    
    <!-- 空状态 -->
    <mo-empty-task v-if="taskList.length === 0" />
  </div>
</template>
```

#### TaskItem.vue - 单个任务项
```vue
<template>
  <div class="task-item" @dblclick="onDbClick">
    <el-row type="flex">
      <!-- 选择框 -->
      <el-col :span="2">
        <el-checkbox :value="isSelected" @change="handleSelect" />
      </el-col>
      
      <!-- 任务信息 -->
      <el-col :span="22">
        <!-- 任务名称和大小 -->
        <el-row>
          <el-col :span="16">
            <div class="task-name" :title="taskFullName">
              {{ taskFullName }}
            </div>
          </el-col>
          <el-col :span="8">
            <div class="task-progress-num">
              {{ task.completedLength | bytesToSize(2) }}
              <span v-if="task.totalLength > 0">
                / {{ task.totalLength | bytesToSize(2) }}
              </span>
            </div>
          </el-col>
        </el-row>
        
        <!-- 进度条 -->
        <mo-task-progress
          :completed="Number(task.completedLength)"
          :total="Number(task.totalLength)"
          :status="taskStatus"
        />
        
        <!-- 详细信息和操作 -->
        <div class="task-info-actions">
          <mo-task-progress-info :task="task" />
          <mo-task-item-actions mode="LIST" :task="task" />
        </div>
      </el-col>
    </el-row>
  </div>
</template>
```

### 3. 任务详情组件 (TaskDetail/Index.vue)

```vue
<template>
  <el-drawer
    custom-class="task-detail-drawer"
    size="61.8%"
    :visible="visible"
    :title="$t('task.task-detail-title')"
  >
    <el-tabs value="general" @tab-click="handleTabClick">
      <!-- 基本信息标签页 -->
      <el-tab-pane name="general">
        <span slot="label">
          <i class="el-icon-info"></i>
        </span>
        <mo-task-general :task="task" />
      </el-tab-pane>
      
      <!-- 活动图标签页 -->
      <el-tab-pane name="activity" lazy>
        <span slot="label">
          <i class="el-icon-s-grid"></i>
        </span>
        <mo-task-activity :task="task" />
      </el-tab-pane>
      
      <!-- Tracker 标签页 (BT 任务) -->
      <el-tab-pane name="trackers" lazy v-if="isBT">
        <span slot="label">
          <i class="el-icon-discover"></i>
        </span>
        <mo-task-trackers :task="task" />
      </el-tab-pane>
    </el-tabs>
    
    <!-- 操作按钮 -->
    <div class="task-detail-actions">
      <mo-task-item-actions mode="DETAIL" :task="task" />
    </div>
  </el-drawer>
</template>
```

### 4. 进度组件

#### TaskProgress.vue - 进度条
```vue
<template>
  <div class="task-progress-wrapper">
    <el-progress
      :percentage="percentage"
      :status="progressStatus"
      :show-text="false"
      :stroke-width="6"
    />
  </div>
</template>

<script>
export default {
  props: {
    completed: Number,
    total: Number,
    status: String
  },
  
  computed: {
    percentage() {
      if (this.total === 0) return 0
      return Math.floor((this.completed / this.total) * 100)
    },
    
    progressStatus() {
      switch (this.status) {
        case 'complete':
          return 'success'
        case 'error':
          return 'exception'
        case 'paused':
          return 'warning'
        default:
          return null
      }
    }
  }
}
</script>
```

#### TaskProgressInfo.vue - 进度信息
```vue
<template>
  <div class="task-progress-info">
    <!-- 状态显示 -->
    <span class="task-status" :class="`status-${taskStatus}`">
      {{ statusText }}
    </span>
    
    <!-- 速度信息 -->
    <span v-if="showSpeed" class="task-speed">
      <i class="el-icon-download"></i>
      {{ task.downloadSpeed | bytesToSize }}/s
      <i class="el-icon-upload2" v-if="task.uploadSpeed > 0"></i>
      <span v-if="task.uploadSpeed > 0">
        {{ task.uploadSpeed | bytesToSize }}/s
      </span>
    </span>
    
    <!-- ETA -->
    <span v-if="showEta" class="task-eta">
      {{ eta }}
    </span>
  </div>
</template>
```

### 5. 操作组件

#### TaskItemActions.vue - 任务操作按钮
```vue
<template>
  <div class="task-item-actions" :class="`mode-${mode}`">
    <!-- 播放/暂停按钮 -->
    <el-button
      v-if="canResume"
      type="text"
      @click="handleResume"
      :title="$t('task.resume-task')"
    >
      <mo-icon name="task-start" />
    </el-button>
    
    <el-button
      v-if="canPause"
      type="text"
      @click="handlePause"
      :title="$t('task.pause-task')"
    >
      <mo-icon name="task-pause" />
    </el-button>
    
    <!-- 删除按钮 -->
    <el-button
      type="text"
      @click="handleRemove"
      :title="$t('task.remove-task')"
    >
      <mo-icon name="trash" />
    </el-button>
    
    <!-- 更多操作 -->
    <el-dropdown @command="handleCommand">
      <el-button type="text">
        <mo-icon name="more" />
      </el-button>
      <el-dropdown-menu slot="dropdown">
        <el-dropdown-item command="restart">
          {{ $t('task.restart-task') }}
        </el-dropdown-item>
        <el-dropdown-item command="show-in-folder">
          {{ $t('task.show-in-folder') }}
        </el-dropdown-item>
        <el-dropdown-item command="copy-link">
          {{ $t('task.copy-link') }}
        </el-dropdown-item>
      </el-dropdown-menu>
    </el-dropdown>
  </div>
</template>
```

### 6. 添加任务组件 (AddTask.vue)

```vue
<template>
  <el-dialog
    class="add-task-dialog"
    width="67vw"
    :visible="visible"
    @close="handleClose"
  >
    <el-form ref="taskForm" :model="form" :rules="rules">
      <!-- 任务类型标签页 -->
      <el-tabs :value="type" @tab-click="handleTabClick">
        <!-- URI 任务 -->
        <el-tab-pane :label="$t('task.uri-task')" name="uri">
          <el-input
            type="textarea"
            :autosize="{ minRows: 3, maxRows: 5 }"
            :placeholder="$t('task.uri-task-tips')"
            v-model="form.uris"
            @paste.native="handleUriPaste"
          />
        </el-tab-pane>
        
        <!-- Torrent 任务 -->
        <el-tab-pane :label="$t('task.torrent-task')" name="torrent">
          <mo-select-torrent @change="handleTorrentChange" />
        </el-tab-pane>
      </el-tabs>
      
      <!-- 任务选项 -->
      <el-form-item :label="$t('task.task-out')">
        <el-input
          v-model="form.out"
          :placeholder="$t('task.task-out-tips')"
        />
      </el-form-item>
      
      <!-- 下载目录选择 -->
      <el-form-item :label="$t('task.task-dir')">
        <mo-select-directory v-model="form.dir" />
      </el-form-item>
    </el-form>
    
    <!-- 对话框按钮 -->
    <div slot="footer">
      <el-button @click="handleCancel">
        {{ $t('app.cancel') }}
      </el-button>
      <el-button type="primary" @click="handleSubmit">
        {{ $t('app.submit') }}
      </el-button>
    </div>
  </el-dialog>
</template>
```

## 图标系统

### SVG 图标组件 (Icons/Icon.vue)

```vue
<template>
  <svg class="mo-icon" :width="width" :height="height" aria-hidden="true">
    <use :href="`#icon-${name}`"></use>
  </svg>
</template>

<script>
export default {
  name: 'mo-icon',
  props: {
    name: String,
    width: {
      type: [String, Number],
      default: 16
    },
    height: {
      type: [String, Number],
      default: 16
    }
  }
}
</script>
```

### 图标注册系统
```javascript
// Icons/task-start.js
export default {
  name: 'task-start',
  data: `<svg>
    <path d="M8 5v14l11-7z"/>
  </svg>`
}

// 自动注册所有图标
const requireComponent = require.context('./Icons', false, /\.js$/)
requireComponent.keys().forEach(fileName => {
  const componentConfig = requireComponent(fileName)
  const iconName = fileName.replace(/^\.\//, '').replace(/\.js$/, '')
  // 注册图标到全局 SVG Sprite
})
```

## 主题系统

### CSS 变量架构

```scss
// Theme/Variables.scss
:root {
  // 基础色彩
  --color-primary: #409eff;
  --color-success: #67c23a;
  --color-warning: #e6a23c;
  --color-danger: #f56c6c;
  --color-info: #909399;
  
  // 文本色彩
  --color-text-primary: #303133;
  --color-text-regular: #606266;
  --color-text-secondary: #909399;
  --color-text-placeholder: #c0c4cc;
  
  // 背景色彩
  --color-background-primary: #ffffff;
  --color-background-secondary: #f5f7fa;
  --color-background-tertiary: #ebeef5;
  
  // 边框色彩
  --color-border-base: #dcdfe6;
  --color-border-light: #e4e7ed;
  --color-border-lighter: #ebeef5;
}

// 深色主题
.theme-dark {
  --color-text-primary: #ffffff;
  --color-text-regular: #e5e5e5;
  --color-text-secondary: #b3b3b3;
  --color-text-placeholder: #8c8c8c;
  
  --color-background-primary: #1d1e1f;
  --color-background-secondary: #25262a;
  --color-background-tertiary: #2c2d32;
  
  --color-border-base: #404040;
  --color-border-light: #353535;
  --color-border-lighter: #2a2a2a;
}
```

### 主题切换机制

```javascript
// App.vue
export default {
  computed: {
    themeClass() {
      if (this.theme === APP_THEME.AUTO) {
        return `theme-${this.systemTheme}`
      } else {
        return `theme-${this.theme}`
      }
    }
  },
  
  methods: {
    updateRootClassName() {
      const { themeClass, i18nClass, directionClass } = this
      const className = `${themeClass} ${i18nClass} ${directionClass}`
      document.documentElement.className = className
    }
  },
  
  watch: {
    themeClass() {
      this.updateRootClassName()
    }
  }
}
```

## 响应式设计

### 断点系统
```scss
// 基于 Element UI 的断点
$--sm: 768px;
$--md: 992px;
$--lg: 1200px;
$--xl: 1920px;

// 响应式 Mixin
@mixin respond-to($breakpoint) {
  @if $breakpoint == 'small' {
    @media (max-width: #{$--sm - 1px}) {
      @content;
    }
  }
  @if $breakpoint == 'medium' {
    @media (min-width: #{$--sm}) and (max-width: #{$--md - 1px}) {
      @content;
    }
  }
  @if $breakpoint == 'large' {
    @media (min-width: #{$--md}) {
      @content;
    }
  }
}
```

### 响应式组件行为
```vue
<template>
  <div class="task-item">
    <!-- 桌面版布局 -->
    <el-row type="flex" class="hidden-sm-and-down">
      <el-col :span="2">...</el-col>
      <el-col :span="22">...</el-col>
    </el-row>
    
    <!-- 移动版布局 -->
    <div class="hidden-md-and-up">
      <!-- 简化的移动版布局 -->
    </div>
  </div>
</template>
```

## 组件通信模式

### 父子组件通信
```vue
<!-- 父组件 -->
<template>
  <mo-task-item
    :task="task"
    @select="handleTaskSelect"
    @action="handleTaskAction"
  />
</template>

<!-- 子组件 -->
<script>
export default {
  props: ['task'],
  
  methods: {
    handleSelect() {
      this.$emit('select', this.task.gid)
    },
    
    handleAction(action) {
      this.$emit('action', { action, gid: this.task.gid })
    }
  }
}
</script>
```

### 跨组件通信 (Event Bus)
```javascript
// utils/eventBus.js
import Vue from 'vue'
export default new Vue()

// 发送事件
EventBus.$emit('task-updated', taskData)

// 监听事件
EventBus.$on('task-updated', this.handleTaskUpdate)
```

## 性能优化

### 虚拟滚动
```vue
<!-- 大列表优化 -->
<template>
  <div class="virtual-list" ref="container">
    <div
      class="virtual-list-item"
      v-for="item in visibleItems"
      :key="item.id"
      :style="{ transform: `translateY(${item.offset}px)` }"
    >
      <mo-task-item :task="item.data" />
    </div>
  </div>
</template>
```

### 组件懒加载
```javascript
// 路由懒加载
const TaskDetail = () => import('@/components/TaskDetail/Index')

// 动态组件
components: {
  TaskDetail: () => import('@/components/TaskDetail/Index')
}
```

### 图片懒加载
```vue
<template>
  <img
    v-lazy="imageSrc"
    :src="placeholder"
    alt="task thumbnail"
  />
</template>
```

这种 UI 组件架构确保了 imFile 具有现代化的用户界面、良好的用户体验和优秀的性能表现。通过组件化开发和响应式设计，应用能够在不同设备和屏幕尺寸上提供一致的使用体验。