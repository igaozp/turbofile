# imFile 渲染进程架构详解

## 概述

渲染进程是 imFile 的前端部分，使用 Vue.js 2.7 + Vuex + Vue Router 构建。它负责用户界面的渲染、用户交互处理以及与主进程的通信。渲染进程采用组件化架构，具有良好的可维护性和可扩展性。

## 技术栈

### 核心框架
- **Vue.js 2.7** - 渐进式框架
- **Vuex** - 状态管理
- **Vue Router** - 客户端路由
- **Element UI** - UI 组件库

### 构建工具
- **Webpack** - 模块打包
- **SCSS** - CSS 预处理器
- **Tailwind CSS** - 原子化 CSS 框架

## 项目结构

```
renderer/
├── api/                    # API 通信层
├── assets/                 # 静态资源
├── components/             # Vue 组件
├── pages/                  # 页面入口
├── router/                 # 路由配置
├── store/                  # Vuex 状态管理
├── utils/                  # 工具函数
└── workers/                # Web Workers
```

## 应用入口

### App.vue - 根组件

```vue
<template>
  <div id="app">
    <mo-title-bar v-if="isRenderer" :showActions="showWindowActions" />
    <router-view />
    <mo-engine-client :secret="rpcSecret" />
    <mo-ipc v-if="isRenderer" />
    <mo-dynamic-tray v-if="enableTraySpeedometer" />
  </div>
</template>
```

#### 核心功能：
1. **标题栏管理**：Windows/Linux 下的自定义标题栏
2. **路由视图**：主要内容区域
3. **引擎客户端**：与 Aria2 的通信组件
4. **IPC 通信**：与主进程的通信组件
5. **动态托盘**：macOS 下的托盘速度显示

#### 主题系统：
```javascript
computed: {
  themeClass() {
    if (this.theme === APP_THEME.AUTO) {
      return `theme-${this.systemTheme}`
    } else {
      return `theme-${this.theme}`
    }
  }
}
```

## 路由架构

### 路由配置 (router/index.js)

```javascript
routes: [
  {
    path: '/',
    name: 'main',
    component: Main,
    children: [
      {
        path: '/task/:status?',
        name: 'task',
        component: TaskIndex,  // 任务管理页面
        props: true
      },
      {
        path: '/preference',
        name: 'preference',
        component: PreferenceIndex,  // 设置页面
        children: [
          { path: 'basic', component: Basic },      // 基础设置
          { path: 'advanced', component: Advanced }, // 高级设置
          { path: 'lab', component: Lab }           // 实验功能
        ]
      }
    ]
  }
]
```

### 页面结构
1. **主页面** (`/`) - 任务列表（默认显示活动任务）
2. **任务页面** (`/task/:status`) - 按状态筛选的任务列表
3. **设置页面** (`/preference`) - 应用设置
   - 基础设置 (`/preference/basic`)
   - 高级设置 (`/preference/advanced`)
   - 实验功能 (`/preference/lab`)

## 状态管理 (Vuex)

### Store 结构

```javascript
// store/index.js
export default new Vuex.Store({
  modules: {
    app,          // 应用状态
    task,         // 任务状态
    preference    // 偏好设置
  }
})
```

### App 模块 (store/modules/app.js)

管理应用级别的状态：

```javascript
const state = {
  systemTheme: getSystemTheme(),        // 系统主题
  trayFocused: false,                   // 托盘焦点状态
  aboutPanelVisible: false,             // 关于面板可见性
  engineInfo: {                         // 引擎信息
    version: '',
    enabledFeatures: []
  },
  engineOptions: {},                    // 引擎选项
  interval: BASE_INTERVAL,              // 更新间隔
  stat: {                              // 全局统计
    downloadSpeed: 0,                   // 下载速度
    uploadSpeed: 0,                     // 上传速度
    numActive: 0,                       // 活动任务数
    numWaiting: 0,                      // 等待任务数
    numStopped: 0                       // 停止任务数
  },
  addTaskVisible: false,                // 添加任务对话框
  addTaskType: ADD_TASK_TYPE.URI,       // 任务类型
  addTaskUrl: '',                       // 任务 URL
  addTaskTorrents: [],                  // Torrent 文件列表
  addTaskOptions: {},                   // 任务选项
  progress: 0                           // 全局进度
}
```

### Task 模块 (store/modules/task.js)

管理任务相关状态：

```javascript
const state = {
  currentList: 'active',                // 当前列表类型
  taskDetailVisible: false,             // 任务详情可见性
  currentTaskGid: EMPTY_STRING,         // 当前任务 GID
  enabledFetchPeers: false,            // 是否获取对等点
  currentTaskItem: null,                // 当前任务项
  currentTaskFiles: [],                 // 当前任务文件
  currentTaskPeers: [],                 // 当前任务对等点
  seedingList: [],                      // 做种列表
  taskList: [],                         // 任务列表
  count: {                             // 任务计数
    downloading: 0,                     // 下载中
    seeding: 0,                        // 做种中
    waiting: 0,                        // 等待中
    stoped: 0                          // 已停止
  },
  selectedGidList: []                   // 选中的任务 GID 列表
}
```

#### 主要 Actions：
```javascript
const actions = {
  changeCurrentList({ commit, dispatch }, currentList) {
    commit('CHANGE_CURRENT_LIST', currentList)
    commit('UPDATE_SELECTED_GID_LIST', [])
    dispatch('fetchList')
  },
  
  fetchAllList({ commit }) {
    return api.fetchAllTaskList().then(data => {
      // 处理任务列表数据
      const downloadingList = data[0][0].concat(data[1][0])
      const downloading = downloadingList.filter(item => 
        item.completedLength !== item.totalLength
      ).length
      // 更新计数统计
      commit('UPDATE_COUNT', { downloading, seeding, waiting, stoped })
    })
  }
}
```

### Preference 模块 (store/modules/preference.js)

管理用户偏好设置（通过 IPC 与主进程同步）。

## API 通信层

### Api 类 (api/Api.js)

负责与 Aria2 引擎和主进程的通信：

```javascript
export default class Api {
  constructor(options = {}) {
    this.options = options
    this.init()
  }

  async init() {
    this.config = await this.loadConfig()  // 加载配置
    this.client = this.initClient()        // 初始化 Aria2 客户端
    this.client.open()                     // 建立连接
  }

  initClient() {
    const { rpcListenPort: port, rpcSecret: secret } = this.config
    const host = ENGINE_RPC_HOST
    return new Aria2({ host, port, secret })  // 创建 Aria2 客户端
  }
}
```

#### 主要通信方式：
1. **IPC 通信**：与主进程通信获取配置和状态
2. **Aria2 JSON-RPC**：直接与 Aria2 引擎通信
3. **WebSocket**：实时接收下载进度更新

## 核心组件架构

### 组件分类

```
components/
├── Task/                  # 任务相关组件
│   ├── Index.vue          # 任务页面主容器
│   ├── TaskList.vue       # 任务列表
│   ├── TaskItem.vue       # 任务项
│   ├── AddTask.vue        # 添加任务对话框
│   └── ...
├── TaskDetail/            # 任务详情组件
│   ├── Index.vue          # 详情主容器
│   ├── TaskGeneral.vue    # 基本信息
│   ├── TaskFiles.vue      # 文件列表
│   ├── TaskPeers.vue      # 对等点信息
│   └── ...
├── Preference/            # 设置组件
│   ├── Index.vue          # 设置主容器
│   ├── Basic.vue          # 基础设置
│   ├── Advanced.vue       # 高级设置
│   └── ...
├── Native/                # 原生功能组件
│   ├── EngineClient.vue   # 引擎客户端
│   ├── Ipc.vue           # IPC 通信
│   ├── TitleBar.vue      # 标题栏
│   └── ...
└── ...
```

### 关键组件详解

#### 1. TaskList.vue - 任务列表
- 显示不同状态的任务
- 支持多选操作
- 实时更新任务状态
- 虚拟滚动优化性能

#### 2. AddTask.vue - 添加任务对话框
- 支持 URL/Magnet 链接添加
- 支持 Torrent 文件上传
- 任务选项配置
- 批量添加支持

#### 3. EngineClient.vue - 引擎客户端
- 维护与 Aria2 的 WebSocket 连接
- 处理实时事件通知
- 管理连接状态

#### 4. Ipc.vue - IPC 通信
- 处理与主进程的 IPC 消息
- 同步配置更改
- 处理系统事件

## 数据流转

### 组件通信模式

```
用户操作 → 组件事件 → Vuex Actions → API 调用 → 后端处理
    ↑                    ↓              ↓
界面更新 ← Vuex Mutations ← API 响应 ← IPC/WebSocket
```

### 实时数据更新

1. **WebSocket 连接**：
   ```javascript
   // EngineClient.vue
   onNotification(notification) {
     const { method, params } = notification
     switch (method) {
       case 'aria2.onDownloadStart':
         this.handleDownloadStart(params)
         break
       case 'aria2.onDownloadComplete':
         this.handleDownloadComplete(params)
         break
       // 其他事件处理
     }
   }
   ```

2. **定时轮询**：
   ```javascript
   // 定时获取全局统计信息
   setInterval(() => {
     this.$store.dispatch('app/fetchGlobalStat')
   }, this.interval)
   ```

## 主题系统

### CSS 变量架构

```scss
// Variables.scss
:root {
  // 浅色主题
  &.theme-light {
    --color-primary: #409eff;
    --color-background: #ffffff;
    --color-text: #303133;
  }
  
  // 深色主题
  &.theme-dark {
    --color-primary: #409eff;
    --color-background: #1d1e1f;
    --color-text: #ffffff;
  }
}
```

### 动态主题切换

```javascript
// App.vue
updateRootClassName() {
  const { themeClass = '', i18nClass = '', directionClass = '' } = this
  const className = `${themeClass} ${i18nClass} ${directionClass}`
  document.documentElement.className = className
}
```

## 国际化支持

### 语言切换机制

```javascript
// App.vue
watch: {
  locale(val) {
    const lng = getLanguage(val)
    getLocaleManager().changeLanguage(lng)
  }
}
```

支持 30+ 种语言，包括：中文、英文、日文、韩文、法文、德文、俄文等。

## 性能优化

### 1. 虚拟滚动
- 任务列表使用虚拟滚动减少 DOM 节点
- 提高大量任务时的渲染性能

### 2. 组件懒加载
- 路由组件按需加载
- 减少初始包大小

### 3. 状态管理优化
- 模块化 Vuex Store
- 避免不必要的状态更新

### 4. API 请求优化
- 请求防抖和节流
- 智能更新间隔调整

这种架构设计使得 imFile 的渲染进程具有良好的用户体验、优秀的性能表现和强大的可扩展性。