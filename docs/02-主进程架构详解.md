# imFile 主进程架构详解

## 概述

主进程是 Electron 应用的核心，负责管理应用生命周期、创建窗口、处理系统级操作以及与 Aria2 下载引擎的交互。imFile 的主进程采用了管理器模式的设计，将不同功能模块解耦，便于维护和扩展。

## 核心类：Application

`Application.js` 是主进程的入口类，继承自 `EventEmitter`，负责协调所有管理器的初始化和运行。

### 初始化流程

```javascript
init() {
  this.initContext()           // 初始化应用上下文
  this.initConfigManager()     // 初始化配置管理器
  this.setupLogger()          // 设置日志系统
  this.initLocaleManager()    // 初始化国际化
  this.setupApplicationMenu() // 设置应用菜单
  this.initWindowManager()    // 初始化窗口管理器
  this.initUPnPManager()      // 初始化 UPnP 管理器
  this.startEngine()          // 启动 Aria2 引擎
  this.initEngineClient()     // 初始化引擎客户端
  this.initThemeManager()     // 初始化主题管理器
  this.initTrayManager()      // 初始化托盘管理器
  this.initTouchBarManager()  // 初始化 TouchBar（macOS）
  this.initDockManager()      // 初始化 Dock（macOS）
  this.initAutoLaunchManager() // 初始化自动启动
  this.initEnergyManager()    // 初始化电源管理
  this.initProtocolManager()  // 初始化协议处理
  this.initUpdaterManager()   // 初始化更新管理器
  this.handleCommands()       // 处理命令行参数
  this.handleEvents()         // 处理应用事件
  this.handleIpcMessages()    // 处理 IPC 消息
  this.handleIpcInvokes()     // 处理 IPC 调用
}
```

## 核心管理器模块

### 1. Engine（下载引擎管理器）

`Engine.js` 负责管理 Aria2 下载引擎进程。

#### 主要功能：
- **进程管理**：启动、停止 Aria2 进程
- **配置管理**：处理 Aria2 配置参数
- **进程监控**：监控引擎进程状态
- **跨平台支持**：处理不同平台的二进制文件

#### 核心方法：
```javascript
start() {
  const binPath = this.getEngineBinPath()  // 获取平台对应的 Aria2 二进制文件
  const args = this.getStartArgs()         // 构建启动参数
  this.instance = spawn(binPath, args)     // 启动 Aria2 进程
}

stop() {
  if (this.instance) {
    this.instance.kill()  // 终止 Aria2 进程
    this.instance = null
  }
}
```

#### Aria2 二进制文件位置：
```
extra/
├── win32/
│   ├── ia32/engine/aria2c.exe
│   └── x64/engine/aria2c.exe
├── darwin/
│   ├── arm64/engine/aria2c
│   └── x64/engine/aria2c
└── linux/
    ├── arm64/engine/aria2c
    ├── armv7l/engine/aria2c
    └── x64/engine/aria2c
```

### 2. EngineClient（引擎客户端）

`EngineClient.js` 负责与 Aria2 引擎的 JSON-RPC 通信。

#### 通信方式：
- **WebSocket**：实时双向通信，接收下载进度更新
- **HTTP**：发送 RPC 命令

#### 主要功能：
- 发送下载任务指令
- 接收下载状态更新
- 处理引擎事件通知

### 3. ConfigManager（配置管理器）

`ConfigManager.js` 使用 `electron-store` 管理应用配置。

#### 配置文件结构：
- **system.json**：系统级配置（Aria2 参数等）
- **user.json**：用户偏好设置

#### 配置优先级：
```
system.json > 内置 aria2.conf
```

#### 主要配置项：
```javascript
defaults: {
  // 下载设置
  'max-concurrent-downloads': 5,
  'max-connection-per-server': 16,
  'split': 16,
  'min-split-size': '1M',
  
  // 网络设置
  'rpc-listen-port': 16800,
  'enable-rpc': true,
  'rpc-allow-origin-all': true,
  
  // 文件设置
  'dir': getUserDownloadsPath(),
  'continue': true,
  'auto-file-renaming': false
}
```

### 4. UI 管理器

#### WindowManager（窗口管理器）
- 创建和管理应用主窗口
- 处理窗口状态（最小化、最大化、关闭）
- 管理窗口位置和大小

#### MenuManager（菜单管理器）
- 创建应用菜单（macOS/Windows/Linux）
- 处理菜单事件
- 支持不同平台的菜单风格

#### TrayManager（托盘管理器）
- 创建系统托盘图标
- 显示托盘菜单
- 处理托盘事件（点击、右键等）

#### ThemeManager（主题管理器）
- 管理应用主题（浅色/深色/自动）
- 同步系统主题设置
- 更新窗口主题

### 5. 网络管理器

#### UPnPManager（UPnP 管理器）
- 自动端口映射
- NAT 穿透支持
- 提高 P2P 下载效率

#### ProtocolManager（协议管理器）
- 处理 Magnet 链接
- 处理 .torrent 文件关联
- 注册自定义协议

### 6. 系统集成管理器

#### AutoLaunchManager（自动启动管理器）
- 管理开机自启动
- 跨平台自启动支持

#### UpdateManager（更新管理器）
- 检查应用更新
- 自动下载和安装更新
- 使用 `electron-updater`

#### EnergyManager（电源管理器）
- 防止系统休眠（下载时）
- 管理电源状态

## IPC 通信架构

### 消息类型

#### IPC Messages（单向消息）
```javascript
// 主进程 → 渲染进程
ipcMain.emit('task-list-change', tasks)
ipcMain.emit('download-progress', progress)

// 渲染进程 → 主进程
ipcMain.on('add-task', handler)
ipcMain.on('pause-task', handler)
```

#### IPC Invokes（双向调用）
```javascript
// 渲染进程调用，主进程响应
ipcMain.handle('get-config', () => config)
ipcMain.handle('set-config', (key, value) => {})
```

### 主要 IPC 接口

```javascript
// 任务管理
'add-task'           // 添加下载任务
'pause-task'         // 暂停任务
'resume-task'        // 恢复任务
'remove-task'        // 删除任务
'purge-task'         // 清理任务

// 配置管理
'get-config'         // 获取配置
'set-config'         // 设置配置
'reset-config'       // 重置配置

// 文件操作
'show-item-in-folder' // 在文件夹中显示
'select-directory'    // 选择目录
'select-file'        // 选择文件
```

## 事件流转

```
应用启动 → 初始化管理器 → 启动 Aria2 → 连接引擎客户端 → 准备就绪
    ↑                                                    ↓
渲染进程创建 ← IPC 通信建立 ← 窗口管理器创建主窗口 ← 应用事件处理
```

## 错误处理

### 异常处理器
`ExceptionHandler.js` 负责全局异常处理：
- 捕获未处理的异常
- 记录错误日志
- 显示错误对话框
- 防止应用崩溃

### 日志系统
`Logger.js` 提供统一的日志接口：
- 分级日志（info、warn、error）
- 文件日志输出
- 开发环境控制台输出

这种管理器模式的架构设计使得 imFile 主进程具有良好的可维护性和可扩展性，每个管理器职责单一，便于独立开发和测试。