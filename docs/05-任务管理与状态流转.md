# imFile 任务管理与状态流转详解

## 概述

imFile 的任务管理系统负责处理下载任务的完整生命周期，包括任务创建、状态监控、进度更新、用户操作以及任务完成后的处理。系统采用状态机模式管理任务状态，确保状态转换的一致性和可预测性。

## 任务状态定义

### 状态常量 (constants.js)

```javascript
export const TASK_STATUS = {
  ACTIVE: 'active',       // 活动中（下载中）
  WAITING: 'waiting',     // 等待中（队列中）
  PAUSED: 'paused',       // 已暂停
  ERROR: 'error',         // 错误状态
  COMPLETE: 'complete',   // 下载完成
  REMOVED: 'removed',     // 已删除
  SEEDING: 'seeding'      // 做种中（BT 任务）
}

export const ADD_TASK_TYPE = {
  URI: 'uri',            // URL/Magnet 链接
  TORRENT: 'torrent'     // Torrent 文件
}
```

### 状态流转图

```
       [创建]
         ↓
    [WAITING] ←→ [ACTIVE] ←→ [PAUSED]
         ↓           ↓         ↓
    [REMOVED]   [COMPLETE]  [ERROR]
                    ↓
                [SEEDING] (BT 任务)
                    ↓
                [REMOVED]
```

## 任务数据结构

### 任务对象结构

```javascript
const task = {
  gid: 'a1b2c3d4',                    // 任务唯一标识符
  status: 'active',                   // 任务状态
  totalLength: '1073741824',          // 总大小（字节）
  completedLength: '536870912',       // 已完成大小（字节）
  downloadSpeed: '2097152',           // 下载速度（字节/秒）
  uploadSpeed: '1048576',             // 上传速度（字节/秒）
  dir: '/Users/user/Downloads',       // 下载目录
  files: [                            // 文件列表
    {
      index: '1',
      path: '/Users/user/Downloads/file.zip',
      length: '1073741824',
      completedLength: '536870912',
      selected: 'true'
    }
  ],
  bittorrent: {                       // BT 任务信息
    announceList: [                   // Tracker 列表
      ['http://tracker1.example.com:8080/announce'],
      ['http://tracker2.example.com:8080/announce']
    ],
    comment: 'Example torrent',
    creationDate: 1609459200,
    mode: 'multi',                    // single/multi
    info: {
      name: 'example-file'
    }
  },
  infoHash: 'a1b2c3d4e5f6...',       // BT 信息哈希
  numSeeders: '10',                   // 种子数
  numPeers: '25',                     // 对等点数
  connections: '8',                   // 当前连接数
  errorCode: '0',                     // 错误代码
  errorMessage: ''                    // 错误消息
}
```

## 任务创建流程

### 1. AddTask 组件

`AddTask.vue` 提供任务创建界面：

```vue
<template>
  <el-dialog class="add-task-dialog" :visible="visible">
    <el-form ref="taskForm" :model="form" :rules="rules">
      <el-tabs :value="type" @tab-click="handleTabClick">
        <!-- URI 任务标签页 -->
        <el-tab-pane :label="$t('task.uri-task')" name="uri">
          <el-input
            type="textarea"
            :placeholder="$t('task.uri-task-tips')"
            v-model="form.uris"
            @paste.native="handleUriPaste"
          />
        </el-tab-pane>
        
        <!-- Torrent 任务标签页 -->
        <el-tab-pane :label="$t('task.torrent-task')" name="torrent">
          <mo-select-torrent @change="handleTorrentChange" />
        </el-tab-pane>
      </el-tabs>
      
      <!-- 任务选项 -->
      <el-form-item :label="$t('task.task-out')">
        <el-input v-model="form.out" :placeholder="$t('task.task-out-tips')" />
      </el-form-item>
    </el-form>
  </el-dialog>
</template>
```

#### 添加任务逻辑：

```javascript
export default {
  methods: {
    // 处理任务提交
    handleSubmit() {
      this.$refs.taskForm.validate(valid => {
        if (!valid) return
        
        const { type } = this
        const options = this.buildOptions()
        
        if (type === ADD_TASK_TYPE.URI) {
          this.addUriTask(options)
        } else if (type === ADD_TASK_TYPE.TORRENT) {
          this.addTorrentTask(options)
        }
      })
    },

    // 添加 URI 任务
    async addUriTask(options) {
      const uris = this.parseUris(this.form.uris)
      
      for (const uri of uris) {
        try {
          await this.$store.dispatch('task/addUri', {
            uris: [uri],
            options
          })
        } catch (err) {
          this.handleAddTaskError(err, uri)
        }
      }
    },

    // 添加 Torrent 任务
    async addTorrentTask(options) {
      const { files } = this.form
      
      for (const file of files) {
        try {
          const torrentData = await this.readTorrentFile(file)
          await this.$store.dispatch('task/addTorrent', {
            torrent: torrentData,
            options
          })
        } catch (err) {
          this.handleAddTaskError(err, file.name)
        }
      }
    },

    // 构建任务选项
    buildOptions() {
      const { out, split, dir } = this.form
      const options = {}
      
      if (out) options.out = out
      if (split) options.split = split
      if (dir) options.dir = dir
      
      return options
    }
  }
}
```

### 2. 任务添加 API

```javascript
// store/modules/task.js - Actions
const actions = {
  // 添加 URI 任务
  async addUri({ commit }, { uris, options = {} }) {
    const response = await api.addUri(uris, options)
    const gid = response
    
    // 更新 UI
    commit('UPDATE_ADD_TASK_VISIBLE', false)
    dispatch('fetchList')
    
    return gid
  },

  // 添加 Torrent 任务
  async addTorrent({ commit }, { torrent, uris = [], options = {} }) {
    const response = await api.addTorrent(torrent, uris, options)
    const gid = response
    
    commit('UPDATE_ADD_TASK_VISIBLE', false)
    dispatch('fetchList')
    
    return gid
  }
}
```

## 任务状态管理

### Vuex Store 结构

```javascript
// store/modules/task.js
const state = {
  currentList: 'active',              // 当前显示的列表类型
  taskDetailVisible: false,           // 任务详情面板可见性
  currentTaskGid: '',                 // 当前选中的任务 GID
  currentTaskItem: null,              // 当前任务详细信息
  currentTaskFiles: [],               // 当前任务文件列表
  currentTaskPeers: [],               // 当前任务对等点列表
  taskList: [],                       // 任务列表
  seedingList: [],                    // 做种任务列表
  selectedGidList: [],                // 选中的任务 GID 列表
  count: {                           // 任务统计
    downloading: 0,                   // 下载中任务数
    seeding: 0,                      // 做种中任务数
    waiting: 0,                      // 等待中任务数
    stoped: 0                        // 已停止任务数
  }
}
```

### 任务列表获取

```javascript
const actions = {
  // 获取所有任务列表
  async fetchAllList({ commit }) {
    try {
      const data = await api.fetchAllTaskList()
      
      // data[0] = active list, data[1] = waiting list, data[2] = stopped list
      const activeList = data[0][0]
      const waitingList = data[1][0]
      const stoppedList = data[2][0]
      
      // 计算任务统计
      const downloadingList = activeList.concat(waitingList)
      const downloading = downloadingList.filter(item => 
        item.completedLength !== item.totalLength
      ).length
      const seeding = downloadingList.filter(item => 
        item.completedLength === item.totalLength
      ).length
      
      commit('UPDATE_COUNT', {
        downloading,
        seeding,
        waiting: waitingList.length,
        stoped: stoppedList.length
      })
      
      return data
    } catch (err) {
      console.error('Failed to fetch task list:', err)
    }
  },

  // 根据当前列表类型获取任务
  async fetchList({ state, commit }) {
    const { currentList } = state
    let list = []
    
    switch (currentList) {
      case 'active':
        list = await api.tellActive()
        break
      case 'waiting':
        list = await api.tellWaiting(0, 1000)
        break
      case 'stopped':
        list = await api.tellStopped(0, 1000)
        break
    }
    
    commit('UPDATE_TASK_LIST', list)
    return list
  }
}
```

## 任务操作

### 任务控制操作

```javascript
const actions = {
  // 暂停任务
  async pauseTask({ dispatch }, gid) {
    await api.pause(gid)
    dispatch('fetchList')
  },

  // 恢复任务
  async resumeTask({ dispatch }, gid) {
    await api.unpause(gid)
    dispatch('fetchList')
  },

  // 删除任务
  async removeTask({ dispatch }, { gid, options = {} }) {
    const { deleteFile = false } = options
    
    // 删除任务
    await api.remove(gid)
    
    // 如果需要删除文件
    if (deleteFile) {
      await this.removeTaskFile(gid)
    }
    
    dispatch('fetchList')
  },

  // 批量操作
  async batchOperation({ state, dispatch }, { operation, options = {} }) {
    const { selectedGidList } = state
    const promises = selectedGidList.map(gid => {
      switch (operation) {
        case 'pause':
          return api.pause(gid)
        case 'resume':
          return api.unpause(gid)
        case 'remove':
          return api.remove(gid)
        default:
          return Promise.resolve()
      }
    })
    
    await Promise.allSettled(promises)
    dispatch('fetchList')
  }
}
```

### TaskItem 组件

`TaskItem.vue` 显示单个任务项：

```vue
<template>
  <div class="task-item" @dblclick="onDbClick">
    <el-row type="flex">
      <!-- 选择框 -->
      <el-col :span="2">
        <el-checkbox :value="selectedGidList.includes(task.gid)" />
      </el-col>
      
      <!-- 任务信息 -->
      <el-col :span="22">
        <!-- 任务名称和大小 -->
        <el-row>
          <el-col :span="16">
            <div class="task-name" :title="taskFullName">
              {{ taskFullName }}
            </div>
          </el-col>
          <el-col :span="8">
            <div class="task-progress-num">
              <span>{{ task.completedLength | bytesToSize(2) }}</span>
              <span v-if="task.totalLength > 0">
                / {{ task.totalLength | bytesToSize(2) }}
              </span>
            </div>
          </el-col>
        </el-row>
        
        <!-- 进度条 -->
        <div class="task-progress">
          <mo-task-progress
            :completed="Number(task.completedLength)"
            :total="Number(task.totalLength)"
            :status="taskStatus"
          />
        </div>
        
        <!-- 详细信息和操作按钮 -->
        <div class="flex flex-row justify-between mt-2">
          <mo-task-progress-info :task="task" />
          <mo-task-item-actions mode="LIST" :task="task" />
        </div>
      </el-col>
    </el-row>
  </div>
</template>
```

#### 任务状态显示逻辑：

```javascript
export default {
  computed: {
    taskStatus() {
      const { status, completedLength, totalLength } = this.task
      
      // 处理特殊状态
      if (status === TASK_STATUS.COMPLETE) {
        if (this.isSeeder) {
          return TASK_STATUS.SEEDING
        }
        return TASK_STATUS.COMPLETE
      }
      
      return status
    },

    isSeeder() {
      return checkTaskIsSeeder(this.task)
    },

    progress() {
      const { completedLength, totalLength } = this.task
      if (totalLength === '0') return 0
      return (Number(completedLength) / Number(totalLength)) * 100
    }
  },

  methods: {
    // 双击打开文件
    onDbClick() {
      if (this.taskStatus === TASK_STATUS.COMPLETE) {
        this.openTaskFile()
      } else {
        this.showTaskDetail()
      }
    },

    openTaskFile() {
      const filePath = getTaskFullPath(this.task)
      openItem(filePath)
    },

    showTaskDetail() {
      this.$store.dispatch('task/showTaskDetail', this.task.gid)
    }
  }
}
```

## 实时状态更新

### WebSocket 事件处理

```javascript
// EngineClient.vue
export default {
  methods: {
    // 监听下载事件
    bindEngineEvents() {
      this.client.on('onDownloadStart', this.onDownloadStart)
      this.client.on('onDownloadPause', this.onDownloadPause)
      this.client.on('onDownloadStop', this.onDownloadStop)
      this.client.on('onDownloadComplete', this.onDownloadComplete)
      this.client.on('onDownloadError', this.onDownloadError)
      this.client.on('onBtDownloadComplete', this.onBtDownloadComplete)
    },

    // 下载开始事件
    onDownloadStart(params) {
      const [{ gid }] = params
      console.log(`Download started: ${gid}`)
      
      // 更新任务列表
      this.$store.dispatch('task/updateTaskStatus', {
        gid,
        status: TASK_STATUS.ACTIVE
      })
      
      // 显示通知
      this.showNotification({
        title: 'Download Started',
        message: 'A new download has started'
      })
    },

    // 下载完成事件
    onDownloadComplete(params) {
      const [{ gid }] = params
      console.log(`Download completed: ${gid}`)
      
      this.$store.dispatch('task/updateTaskStatus', {
        gid,
        status: TASK_STATUS.COMPLETE
      })
      
      // 显示完成通知
      this.showCompletionNotification(gid)
    },

    // 下载错误事件
    onDownloadError(params) {
      const [{ gid }] = params
      console.log(`Download error: ${gid}`)
      
      this.$store.dispatch('task/updateTaskStatus', {
        gid,
        status: TASK_STATUS.ERROR
      })
    }
  }
}
```

### 定时轮询更新

```javascript
// EngineClient.vue
export default {
  data() {
    return {
      timer: null,
      interval: 1000  // 更新间隔（毫秒）
    }
  },

  methods: {
    startPolling() {
      this.timer = setInterval(() => {
        // 获取全局统计信息
        this.fetchGlobalStat()
        
        // 获取当前页面的任务列表
        if (this.$route.name === 'task') {
          this.$store.dispatch('task/fetchList')
        }
        
        // 获取任务详情（如果详情面板打开）
        if (this.taskDetailVisible && this.currentTaskGid) {
          this.fetchTaskDetail(this.currentTaskGid)
        }
      }, this.interval)
    },

    stopPolling() {
      if (this.timer) {
        clearInterval(this.timer)
        this.timer = null
      }
    },

    // 动态调整更新间隔
    adjustInterval() {
      const { numActive } = this.stat
      
      if (numActive === 0) {
        // 没有活动任务时，降低更新频率
        this.interval = 5000
      } else {
        // 有活动任务时，保持正常频率
        this.interval = 1000
      }
    }
  }
}
```

## 错误处理与恢复

### 任务错误处理

```javascript
const actions = {
  // 处理任务错误
  async handleTaskError({ dispatch }, { gid, error }) {
    console.error(`Task ${gid} error:`, error)
    
    // 记录错误日志
    logger.error('Task error', { gid, error })
    
    // 尝试重新启动任务
    if (error.code === 'NETWORK_ERROR') {
      await this.retryTask(gid)
    } else {
      // 标记任务为错误状态
      dispatch('updateTaskStatus', {
        gid,
        status: TASK_STATUS.ERROR,
        errorMessage: error.message
      })
    }
  },

  // 重试任务
  async retryTask({ dispatch }, gid) {
    try {
      // 暂停任务
      await api.pause(gid)
      
      // 等待一段时间后重新开始
      setTimeout(async () => {
        await api.unpause(gid)
        dispatch('fetchList')
      }, 3000)
    } catch (err) {
      console.error('Failed to retry task:', err)
    }
  }
}
```

### 网络连接恢复

```javascript
// 监听网络状态变化
window.addEventListener('online', () => {
  // 网络恢复时，恢复所有暂停的任务
  this.$store.dispatch('task/resumeAllPausedTasks')
})

window.addEventListener('offline', () => {
  // 网络断开时，暂停所有活动任务
  this.$store.dispatch('task/pauseAllActiveTasks')
})
```

这种任务管理架构确保了下载任务的可靠性和用户体验，通过状态机模式保证状态转换的一致性，通过实时更新机制保证信息的及时性，通过错误处理和恢复机制保证系统的稳定性。